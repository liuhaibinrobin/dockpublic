# 目录
- 挂载方法
- 流程
- `tankbind_prototype` 文件夹
    - 数据集构建
    - 训练和测试
- `Nouvelles` 文件夹

# 挂载方法
- `/home/jovyan/`： 挂载持久卷 workspace-sx02（或克隆 git 项目到`/home/jovyan/main_tankbind`）
- `/home/jovyan/dataspace/`： 挂载持久卷 dataspace

期望目录结构：
- `/home/jovyan/`
    - `dataspace/`（来自持久卷）    # 包含所有原始数据，和经过初步处理的数据
        - `Prototype/`  # 经过处理的数据
            - `readme.md`
            - `...`
        - `Internal/`
        - `PDBbind2020/`
        - `readme.md`
        - `...`
    - `main_tankbind/`（来自 gitlab 或持久卷）
        - `dataset_prototype`         # 训练、验证用的数据集在这里
        - `tankbind_prototype/`       # 项目代码在这里
        - `读我.md`（本文件）
        - `...`

# 环境
conda `betabind_py38` 环境，在 `tankbind_py38` 基础上添加了 `tensorboard`。

# 流程

- 使用 `tankbind_prototype/construction_dataset{*}.ipynb` 构建数据集

    在克隆本 git 项目后，如果未按照现有方式挂载 `dataspace` 数据卷，则需要按情况将每一个代码块的 `processed=True` 修改为 `processed=False`，然后运行该脚本，将处理后的数据保存至某个文件夹（原为`dataspace/Prototype`），并在`tankbind_prototype/datasets` 下生成训练、测试用数据集。
    若成功挂载 `dataspace`，请跳到该脚本的『「从这里开始」数据集构建」』，并以该处开始构建训练用数据集。
    
- 使用 `main_prototype.py` 进行训练或测试，使用 `betabind_py38`环境。

# `tankbind_prototype` 文件夹

## 数据集构建

- `construction_dataset_prototype.ipynb` 

    用于构建 `pdbbind` 数据集。

- `construction_dataset_prototype_for_internal.ipynb` 

    用于构建 `QSAR` 内部靶点数据集。

- `construction_dataset_prototype_for_small.ipynb` 

    用于构建 `pdbbind` 小数据集以打通流程（可能需要修改）。

- `./tools/choose_pocket_by_ligand_coor.ipynb`

    包含构筑 `ARC_ligand_coor_dict.pt` 的代码样例，在重新构建数据集时，或许需要使用。


## 训练和测试

`main_prototype.py` 用于训练模型。

参数解释
- `--run_mode`, str, default="iid_ood_test_internal"

    字符串，决定哪些数据集会被使用。可包含 `train`、`iid`、`ood`、`test`、`internal` 五个字符串。是否有连接符号、连接符号是什么则无所谓。例如 `trainiid`、`train-test`、`internal+iid` 都可行。除 `train` 外，其他都不会训练模型参数。

- `--sampler_batch_size`, int, default=6


- `--validation_batch_size`, int, default=8

    决定验证(`iid/ood/test/internal`) 时的 `batch_size`

 - `--data_mode`, str, default="full"

    字符串，`full` 或 `small`，可以使用 `small` 数据集验证流程 `pdbbind` 数据集流程（需要准备该数据集）。

- `--pair_threshold`, float, default=2,

    成对活性真值倍数。当此值为 `2` 时，分子 `A` 和分子 `B` 需满足 `A>2B+d` 才可成对，`d` 为一个不为0的小值。

- `--trainset_seed`, int, default=0,

    训练集是随机抽样生成的：此参数为该随机抽样的种子（`pandas.core.groupby.DataFrameGroupBy.sample:  random_state`）。

- `--use_mse_loss`, bool, default=False

    是否使用`mse loss` 而非 `rank loss`。如果使用 `True`，可能需要修改代码。
                        

- `--output_func`, str, default="no",

    是否在模型最终输出时添加一个函数修正。
    - `no`：无
    - `sig10`：对活性值应用 `.sigmoid()`
    - `sig10-5`：对活性值应用 `.sigmoid()-5`；注意需要引号。


- `--sigmoid_lambda`, float, default=0.5

    rankloss 中的一个参数，太大会导致溢出。


- `--resultFolder`, str, default="./result/"

    输出文件夹路径。

- `--label`, str, default=""

    自定义标签，影响输出结果的文件名/文件夹名字。

- `--save_checkpoint`, bool, default=True

    是否保存 checkpoint。

- `--restart`, str, default=False,
    
    是否从某个模型继续训练。如果是，填入该 `.pt` 文件路径。

- `--restart_epoch`, int, default=-1
    
    如果上一项非 `False`，在此填入该模型的 `epoch` 数。如果未修改模型保存的命名方式，则对于 `epoch_x.pt`，需要填入 `x`。

- `--num_epochs`, int, default=50

    模型总共要跑的 `epoch` 数，从 `0` 开始计算，如果使用--restart、--restart_epoch，请注意 restart_epoch 那一部分 epoch 也会当成已经跑过的 epoch。


- `--learning_rate`, float, default=0.0001

    学习率。

- `--readout_mode`, int, default=1

    原 tankbind 参数，未做改动，可能没有用


### 命令举例

- 使用 train 训练，并输出在 iid、ood、qsar（internal）、test集上的结果
```
main_prototype.py --learning_rate 0.0001 --pair_threshold 2 --readout_mode 1 --num_epochs 50 --run_mode train_iid_ood_test_internal --data_mode full
```

- 使用某个 checkpoint 继续训练，并输出在 iid、ood、qsar、test集上的结果

    注意，--num_epoch 会考虑到已训练过的轮次。例如下述命令中，若 --num_epoch 为 50（最后一个 epoch 为 epoch 49），训练会直接结束：因为 --restart_epoch 是 49，所以模型会跳过 0-49 这 50 个 epoch，然后因为跳过的（50 个）已经达到了 --num_epochs 所要求的 50 个 epoch，模型将不再有 epoch 用于新的训练。
    在填写参数时确保填写了正确的 restart_epoch：该参数会影响到 batch sampler 等模块的随机种子。
    
```
main_prototype.py --learning_rate 0.0001 --pair_threshold 2 --readout_mode 1 --restart /home/jovyan/main_tankbind/tankbind_prototype/result/2023_01_12_11_14_37/models/epoch_49.pt --restart_epoch 49 --num_epochs 100 --run_mode train_iid_ood_internal_test --data_mode full
```

- qsar 测试

    需要将 --restart 换成想要使用的模型的checkpoint
```
main_prototype.py --learning_rate 0.0001 --pair_threshold 2 --readout_mode 1 --restart /home/jovyan/main_tankbind/tankbind_prototype/result/2023_01_12_11_14_37/models/epoch_49.pt --num_epochs -1 --run_mode internal --data_mode full
```

## 开发

以下两个文件有较大改动：
- `main_prototype.py`
- `data_prototype.py`
- `sampler_prototype.py`
    
    新增的 `batch_session_sampler` 在此。

以下文件有较小改动：
- `model.py`

其余文件或有较小改动。



# `Nouvelles` 文件夹
包含 `SWBind` 项目的过期文件。