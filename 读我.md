# 目录
- 流程
- `tankbind_prototype` 文件夹
- `Nouvelles` 文件夹

# 流程

- 使用 `construction_dataset{*}.ipynb` 构建数据集

    在克隆本 git 项目后，如果未按照现有方式挂载 `dataspace` 数据卷，则需要按情况将每一个代码块的 `processed=True` 修改为 `processed=False`，然后运行该脚本，将处理后的数据保存至某个文件夹（原为`dataspace/Prototype`），并在`tankbind_prototype/datasets` 下生成训练、测试用数据集。
    若成功挂载 `dataspace`，请跳到该脚本的 「<font color='gold'>「从这里开始」</font>数据集构建」，并以该处开始构建数据集。
- 使用 `main_prototype.py` 进行训练或测试。

# `tankbind_prototype` 文件夹

## 数据集构建

- `construction_dataset_prototype.ipynb` 

    用于构建 `pdbbind` 数据集。

- `construction_dataset_prototype_for_internal.ipynb` 

    用于构建 `QSAR` 内部靶点数据集。

- `construction_dataset_prototype_for_small.ipynb` 

    用于构建 `pdbbind` 小数据集以打通流程（可能需要修改）。

- `./tools/choose_pocket_by_ligand_coor.ipynb`

    包含构筑 `ARC_ligand_coor_dict.pt` 的代码样例，在重新构建数据集时，或许需要使用。


## 训练

`main_prototype.py` 用于训练模型。

参数解释
- `--run_mode`, str, default="iid_ood_test_internal"

    字符串，决定哪些数据集会被使用。可包含 `train`、`iid`、`ood`、`test`、`internal` 五个字符串。是否有连接符号、连接符号是什么则无所谓。例如 `trainiid`、`train-test`、`internal+iid` 都可行。除 `train` 外，其他都不会训练模型参数。

- `--sampler_batch_size`, int, default=6


- `--validation_batch_size`, int, default=8

    决定验证(`iid/ood/test/internal`) 时的 `batch_size`

 - `--data_mode`, str, default="full"

    字符串，`full` 或 `small`，可以使用 `small` 数据集验证流程 `pdbbind` 数据集流程（需要准备该数据集）。

- `--pair_threshold`, float, default=2,

    成对活性真值倍数。当此值为 `2` 时，分子 `A` 和分子 `B` 需满足 `A>2B+d` 才可成对，`d` 为一个不为0的小值。



- `--use_mse_loss`, bool, default=False

    是否使用`mse loss` 而非 `rank loss`。如果使用 `True`，可能需要修改代码。
                        

- `--output_func`, str, default="no",

    是否在模型最终输出时添加一个函数修正。
    - `no`：无
    - `sig10`：对活性值应用 `.sigmoid()`
    - `sig10-5`：对活性值应用 `.sigmoid()-5`；注意需要引号。




- `--sigmoid_lambda`, float, default=0.5

    rankloss 中的一个参数，太大会导致溢出。


- `--resultFolder`, str, default="./result/"

    输出文件夹路径。

- `--label`, str, default=""

    自定义标签。

- `--save_checkpoint`, bool, default=True

    是否保存 checkpoint。

- `--restart`, str, default=False,
    
    是否从某个模型继续训练。如果是，填入该 `.pt` 文件路径。

- `--restart_epoch`, int, default=-1
    
    如果上一项非 `False`，在此填入该模型的 `epoch` 数。如果未修改模型保存的命名方式，则对于 `epoch_x.pt`，需要填入 `x`。

- `--num_epochs`, int, default=50

    模型总共要跑的 `epoch` 数，从 `0` 开始计算。


- `--learning_rate`, float, default=0.0001

    学习率。

- `--readout_mode`, int, default=1

    原参数，未改动。

```
main_prototype.py --learning_rate 0.0001 --pair_threshold 2 --readout_mode 1 --restart /home/jovyan/main_tankbind/tankbind_prototype/result/2023_01_12_11_14_37/models/epoch_49.pt --restart_epoch -1 --num_epochs 1 --run_mode internal --data_mode full
```


## 开发

以下两个文件有较大改动：
- `main_prototype.py`
- `data_prototype.py`
- `sampler_prototype.py`
    
    新增的 `batch_session_sampler` 在此。

以下文件有较小改动：
- `model.py`

其余文件或有较小改动。



# `Nouvelles` 文件夹
包含 `SWBind` 项目的过期文件。